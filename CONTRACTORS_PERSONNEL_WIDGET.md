# 👥 Виджет персонала на странице объекта

## 📋 Обзор

Виджет `ObjectPersonnelWidget` - это компонент для управления персоналом подрядчиков с доступом к конкретному промышленному объекту. Виджет интегрирован в модальное окно деталей объекта в модуле Каталог.

**Версия:** 2.2  
**Дата создания:** ${new Date().toLocaleDateString('ru-RU')}  
**Статус:** ✅ Активен

---

## 🎯 Назначение

### Бизнес-цели

1. **Контроль доступа** - управление персоналом с доступом к объекту
2. **Безопасность** - проверка соответствия требованиям объекта
3. **Удобство** - назначение персонала без переключения между модулями
4. **Прозрачность** - видеть весь персонал на объекте в одном месте

### Для кого

- **Менеджеры** - контроль персонала на объектах
- **Специалисты по безопасности** - проверка соответствия
- **Администраторы** - управление доступом

---

## 📍 Где находится

### Навигация

```
1. Открыть модуль Каталог (/catalog)
2. Кликнуть на любой объект (откроется модальное окно)
3. Перейти на вкладку "Персонал" (иконка Users)
4. Готово! Виджет отображается
```

### Визуальная структура

```
┌─────────────────────────────────────────────┐
│ Котельная №1                        [×]     │
├─────────────────────────────────────────────┤
│ [Основное] [Контроль сроков] [Персонал]    │
│                              ───────────    │
│                                             │
│ ┌─────────────────────────────────────────┐ │
│ │ 👥 Персонал подрядчиков        [3]      │ │
│ │                         [Назначить]     │ │
│ ├─────────────────────────────────────────┤ │
│ │ Таблица персонала                       │ │
│ │ - Иванов И.И. | ООО "ГазСервис" | ...  │ │
│ │ - Петров П.П. | ООО "ГазСервис" | ...  │ │
│ │ - Сидоров С.С.| ООО "СтройМонтаж"| ...  │ │
│ └─────────────────────────────────────────┘ │
└─────────────────────────────────────────────┘
```

---

## 🎨 Внешний вид

### Заголовок виджета

```
┌────────────────────────────────────────┐
│ 👥 Персонал подрядчиков      [3]      │
│                       [Назначить]     │
└────────────────────────────────────────┘
```

**Элементы:**
- Иконка Users (👥)
- Заголовок "Персонал подрядчиков"
- Бейдж с количеством сотрудников
- Кнопка "Назначить" (с иконкой UserPlus)

### Таблица персонала

| Сотрудник | Подрядчик | Период | Статус | Соответствие | Действия |
|-----------|-----------|--------|--------|--------------|----------|
| **Иванов И.И.**<br/>Слесарь-ремонтник | ООО "ГазСервис" | 01.01.2024<br/>31.12.2024 (365 дн.) | 🟢 Активен | ✅ Соответствует | 🚫 |
| **Петров П.П.**<br/>Электрик | ООО "ГазСервис" | 15.03.2024<br/>Бессрочно | 🟢 Активен | ✅ Соответствует | 🚫 |

**Колонки:**
1. **Сотрудник** - ФИО (жирным) + должность (серым)
2. **Подрядчик** - название организации
3. **Период** - даты начала и окончания доступа с индикаторами
4. **Статус** - цветной бейдж (Активен/Приостановлен/Отозван/Истек)
5. **Соответствие** - бейдж с результатом проверки
6. **Действия** - кнопка отзыва доступа

### Empty State

```
┌────────────────────────────────────────┐
│                                        │
│            👥                          │
│                                        │
│  Нет персонала с доступом к этому     │
│          объекту                       │
│                                        │
│       [Назначить сотрудника]          │
│                                        │
└────────────────────────────────────────┘
```

Показывается когда нет сотрудников с доступом к объекту.

---

## 🔧 Функциональность

### 1. Просмотр персонала

**Что показывает:**
- Список всех сотрудников с доступом к данному объекту
- Информация о подрядчике каждого сотрудника
- Период доступа (дата начала и окончания)
- Статус доступа (активен, приостановлен, отозван, истек)
- Соответствие требованиям объекта
- Количество дней до истечения доступа

**Индикаторы срока доступа:**
- 🟢 Зеленый: > 30 дней до истечения
- 🟠 Оранжевый: ≤ 30 дней до истечения
- 🔴 Красный: ≤ 7 дней или доступ истек
- ♾️ Серый: Бессрочный доступ

### 2. Назначение персонала

**Кнопка "Назначить"** → открывает диалог

**Форма назначения:**
```
┌──────────────────────────────────────────────┐
│ Назначить сотрудника на объект               │
├──────────────────────────────────────────────┤
│                                              │
│ Сотрудник *                                  │
│ [Выберите сотрудника                    ▼]  │
│                                              │
│ Доступ с *              Доступ до           │
│ [01.01.2024]            [31.12.2024]        │
│                         (опционально)        │
│                                              │
│ Вид работ                                    │
│ [Монтаж, Ремонт, Диагностика...]           │
│                                              │
│ Примечания                                   │
│ [Дополнительная информация]                 │
│                                              │
│ ┌─────────────────────────────────────────┐ │
│ │ ✅ Сотрудник соответствует требованиям  │ │
│ │ ✓ Аттестация Б.7.1 (до 15.01.2028)     │ │
│ │ ✓ Медосмотр действителен (до 30.06.25) │ │
│ │ ✓ Обучение ПБ пройдено (до 15.08.2025) │ │
│ │ ✓ Обучение ОТ пройдено (до 01.09.2025) │ │
│ └─────────────────────────────────────────┘ │
│                                              │
│              [Отмена]    [Назначить]        │
└──────────────────────────────────────────────┘
```

**Поля:**
- **Сотрудник** * - выбор из активных сотрудников (с указанием подрядчика)
- **Доступ с** * - дата начала доступа
- **Доступ до** - дата окончания (опционально, если пусто = бессрочно)
- **Вид работ** - описание работ (монтаж, ремонт и т.д.)
- **Примечания** - дополнительная информация

**Автоматическая проверка:**
- При выборе сотрудника показывается карточка соответствия
- Зеленая карточка = сотрудник соответствует всем требованиям
- Список проверенных документов и аттестаций

### 3. Отзыв доступа

**Кнопка 🚫** в колонке "Действия" → открывает диалог подтверждения

**Форма отзыва:**
```
┌──────────────────────────────────────────────┐
│ Отозвать доступ к объекту                    │
├──────────────────────────────────────────────┤
│                                              │
│ Вы уверены, что хотите отозвать доступ?     │
│ Сотрудник больше не сможет посещать этот    │
│ объект.                                      │
│                                              │
│ Причина отзыва                               │
│ [Укажите причину...]                        │
│                                              │
│              [Отмена]  [Отозвать доступ]    │
└──────────────────────────────────────────────┘
```

**Функциональность:**
- Указание причины отзыва (обязательно)
- Подтверждение действия
- Статус автоматически меняется на "Отозван"
- Отозванный доступ нельзя восстановить

---

## 💻 Технические детали

### Props компонента

```typescript
interface ObjectPersonnelWidgetProps {
  objectId: string;        // ID объекта для фильтрации персонала
  objectName: string;      // Название объекта для отображения в форме
  className?: string;      // CSS классы (опционально)
}
```

### Используемые stores

```typescript
// Из contractorsStore
const {
  objectAccess,         // Список назначений персонала
  employees,            // Список сотрудников
  contractors,          // Список подрядчиков
  fetchObjectAccess,    // Загрузка данных о доступе
  grantObjectAccess,    // Назначение персонала
  revokeObjectAccess,   // Отзыв доступа
  fetchEmployees,       // Загрузка сотрудников
  fetchContractors,     // Загрузка подрядчиков
  loading               // Индикатор загрузки
} = useContractorsStore();
```

### Фильтрация данных

```typescript
// Показывает только персонал для данного объекта
const personnelOnObject = objectAccess.filter(
  (access) => access.objectId === objectId
);
```

### Логика проверки срока доступа

```typescript
const checkExpiry = (accessEnd?: string) => {
  if (!accessEnd) return null; // Бессрочный

  const endDate = new Date(accessEnd);
  const now = new Date();
  const daysUntilExpiry = Math.ceil(
    (endDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)
  );

  if (daysUntilExpiry < 0) {
    return { color: 'text-red-600', days: daysUntilExpiry };
  } else if (daysUntilExpiry <= 7) {
    return { color: 'text-red-600', days: daysUntilExpiry };
  } else if (daysUntilExpiry <= 30) {
    return { color: 'text-orange-600', days: daysUntilExpiry };
  }
  return { color: 'text-green-600', days: daysUntilExpiry };
};
```

### Состояния компонента

```typescript
// Диалоги
const [isGrantDialogOpen, setIsGrantDialogOpen] = useState(false);
const [isRevokeDialogOpen, setIsRevokeDialogOpen] = useState(false);

// Выбранный доступ для отзыва
const [selectedAccess, setSelectedAccess] = useState<ContractorEmployeeObject | null>(null);

// Причина отзыва
const [revokeReason, setRevokeReason] = useState('');

// Форма назначения
const [formData, setFormData] = useState({
  employeeId: '',
  objectId: objectId,
  accessStart: new Date().toISOString().split('T')[0],
  accessEnd: '',
  workType: '',
  notes: '',
});
```

---

## 🎯 Сценарии использования

### Сценарий 1: Просмотр персонала на объекте

**Цель:** Узнать, кто имеет доступ к объекту

**Шаги:**
1. Открыть Каталог (`/catalog`)
2. Кликнуть на объект (например, "Котельная №1")
3. Перейти на вкладку "Персонал"
4. Увидеть список всех сотрудников с доступом

**Результат:**
- Видна полная информация о персонале
- Понятно, кто и когда может работать на объекте
- Видны статусы и сроки доступа

### Сценарий 2: Назначение нового сотрудника

**Цель:** Предоставить доступ сотруднику подрядчика

**Шаги:**
1. В виджете персонала нажать "Назначить"
2. Выбрать сотрудника из списка
3. Указать период доступа
4. (Опционально) Указать вид работ
5. Проверить зеленую карточку соответствия ✅
6. Нажать "Назначить"

**Результат:**
- Сотрудник добавлен в таблицу персонала
- Доступ активирован
- Данные синхронизированы с модулем Подрядчики

### Сценарий 3: Отзыв доступа

**Цель:** Отозвать доступ у сотрудника (закончил работы, нарушение и т.д.)

**Шаги:**
1. В таблице персонала найти сотрудника
2. Нажать кнопку 🚫 в колонке "Действия"
3. Указать причину отзыва
4. Подтвердить действие

**Результат:**
- Доступ отозван
- Статус изменен на "Отозван"
- Сотрудник не может больше работать на объекте
- Запись сохранена в истории

### Сценарий 4: Контроль истекающих доступов

**Цель:** Увидеть, у кого скоро истекает доступ

**Шаги:**
1. Открыть виджет персонала
2. Посмотреть на колонку "Период"
3. Обратить внимание на цветные индикаторы

**Результат:**
- 🔴 Красные: критично, до истечения ≤ 7 дней
- 🟠 Оранжевые: предупреждение, ≤ 30 дней
- 🟢 Зеленые: все в порядке, > 30 дней

---

## 🔗 Интеграция

### С модулем Каталог

**Файл:** `src/modules/catalog/components/ObjectDetailsModal.tsx`

```typescript
import ObjectPersonnelWidget from './contractors/ObjectPersonnelWidget';

// В табах
<TabsTrigger value="personnel">
  <Icon name="Users" size={20} />
  <span>Персонал</span>
</TabsTrigger>

// Контент вкладки
<TabsContent value="personnel">
  <ObjectPersonnelWidget 
    objectId={object.id} 
    objectName={object.name}
  />
</TabsContent>
```

### С модулем Подрядчики

**Store:** `contractorsStore.ts`

Виджет использует те же функции, что и модуль Подрядчики:
- `fetchObjectAccess()` - загрузка данных
- `grantObjectAccess()` - назначение
- `revokeObjectAccess()` - отзыв

**Синхронизация:**
- Изменения в виджете → отражаются в модуле Подрядчики
- Изменения в модуле Подрядчики → отражаются в виджете
- Единый источник данных (contractorsStore)

---

## ✅ Преимущества виджета

### Для пользователей

1. **Удобство** - не нужно переключаться между модулями
2. **Контекст** - видно персонал именно для этого объекта
3. **Скорость** - быстрое назначение/отзыв доступа
4. **Прозрачность** - вся информация в одном месте

### Для системы

1. **Единый store** - нет дублирования данных
2. **Переиспользование** - один компонент, два места использования
3. **Масштабируемость** - легко добавить виджет в другие места
4. **Синхронизация** - автоматическая, через store

---

## 🐛 Известные ограничения

### Текущие ограничения

1. **Проверка соответствия** - показывает статичные данные, не использует `required_competencies`
2. **Только для объектов** - виджет работает только в контексте объекта
3. **Без истории** - не показывает историю изменений доступа
4. **Без уведомлений** - не отправляет уведомления об истечении

### Планируется

- Реальная проверка по `required_competencies`
- История изменений доступа
- Интеграция с уведомлениями
- Быстрые фильтры (по подрядчику, статусу)

---

## 📚 Связанные документы

- [CONTRACTORS_SUMMARY.md](./CONTRACTORS_SUMMARY.md) - общая информация о модуле
- [CONTRACTORS_CHANGELOG.md](./CONTRACTORS_CHANGELOG.md) - версия 2.2 с виджетом
- [CONTRACTORS_CATALOG_INTEGRATION.md](./CONTRACTORS_CATALOG_INTEGRATION.md) - детали интеграции
- [CONTRACTORS_USER_GUIDE.md](./CONTRACTORS_USER_GUIDE.md) - руководство пользователя

---

## 🎬 Демонстрация

### Как показать виджет

1. Откройте `/catalog`
2. Кликните на любой объект (например, "Котельная №1")
3. Перейдите на вкладку "Персонал" (третья вкладка с иконкой Users)
4. Готово! Виджет отображается

### Что показать

1. **Empty state** - если нет персонала
2. **Назначение** - кнопка "Назначить" → форма → зеленая карточка ✅
3. **Таблица** - после назначения, показать информацию
4. **Отзыв** - кнопка 🚫 → диалог → указать причину
5. **Индикаторы** - цветные индикаторы сроков доступа

---

**Автор:** AI Assistant (Юра)  
**Версия:** 1.0  
**Дата:** ${new Date().toLocaleDateString('ru-RU')}
